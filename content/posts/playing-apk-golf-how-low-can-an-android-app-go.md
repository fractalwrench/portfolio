---
title: "Playing APK Golf"
subtitle: "How to reduce your Android APK size by 99.99%"
date: 2017-10-08T16:07:19+01:00
---

I came across [this question](https://codegolf.meta.stackexchange.com/questions/10113/the-smallest-android-app-in-the-world/10114) on StackExchange asking what the smallest possible APK is, and had to try it out.

### Ground Rules
We'll start off with the default app generated by Android Studio that displays "Hello World".

However, the only hard rule is that it must be possible to install the APK on an Android device.

### Measuring a Baseline
A new project generated by Android Studio 3 Beta 6 uses the following:

- `minSdkVersion` 15
- AppCompat/Support Library
- Empty activity and layout file

The first thing we'll do is measure a baseline, so that we can quantify any performance improvements. To do this, we'll [create a keystore](https://developer.android.com/studio/publish/app-signing.html#generate-key), sign the app, and measure the file size in bytes using `stat -f%z $filename`.

We'll also install the APK on a Nexus 5x running Oreo, to make sure that the Package Manager doesn't reject it.

![Default App Screenshot](/img/apkgolf/default-app.png)

Beautiful. Our APK weighs in at approximately 1.5Mb.

### Visual Exploration
1.5Mb seems like a lot considering what our app does. Let's explore our project structure and see if there are any easy wins. Android Studio has generated:

- One `MainActivity`, which extends `AppCompatActivity`.
- One layout file with a `ConstraintLayout` root view.
- Values files containing 3 colours, 1 string resource, and 1 theme.
- One `AndroidManifest` referencing the `MainActivity`.
- The `AppCompat` and `ConstraintLayout` support libraries.
- Square, round, and foreground launcher icon PNGs.

The icons seem like the easiest target, given that there are 15 images overall, and 2 XML files under `mipmap-anydpi-v26`. Let's quantify this using the [APK Analyser](https://developer.android.com/studio/build/apk-analyzer.html).

### APK Analyser
Our APK is composed of the following files:

- `classes.dex`: 74%
- res: 20%
- `resources.arsc`: 4%
- `META-INF`: 2%
- `AndroidManifest.xml`: <1%

![Apk Analyser Screenshot](/img/apkgolf/apk-analyser-1.jpg)

#### Dex file
Contrary to our gut feeling, `classes.dex` is the biggest culprit at 73%, and is therefore our first target. The dex file contains Java class definitions in the Dex format, and also references methods in the Android framework and support library.

The `android.support` package references over 13,000 methods, which seems excessive for a Hello World app.

#### Resources
Our res directory has a vast number of layout files, drawables, and animations that were not visible in our project structure. Again, these have been pulled in from the support library package, and weigh in at around 20% of the APK size.

![Apk Analyser Screenshot](/img/apkgolf/apk-analyser-2.jpg)

The `resources.arsc` file also contains a reference to each of these resources.

#### Signing
The `META-INF` folder contains `CERT.SF`, `MANIFEST.MF`, and `CERT.RSA` files, which are required for the [v1 APK signature](https://source.android.com/security/apksigning/v2#v1-verification). `MANIFEST.MF` lists the files in the APK, whereas `CERT.SF` contains a digest of `MANIFEST.MF`, and also an individual digest of each file. `CERT.RSA` contains a public key which verifies the integrity of `CERT.SF`.

![Manifest.mf](/img/apkgolf/manifest-mf.jpg)

There are no *obvious* targets here.

#### Manifest
The AndroidManifest, looks very similar to our original input file, with the exception of resource IDs, which have been replaced with integers in the `0x7F` space.

### Enable minification
We haven't tried enabling minification and resource shrinking in our app's `build.gradle` file. Let's give that a go and observe the results.

```
android {
    buildTypes {
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile(
              'proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
```

```
-keep class com.fractalwrench.** { *; }
```

Setting `minifyEnabled` to true enables [Proguard](https://www.guardsquare.com/en/proguard), which strips unused code from our application. It will also obfuscate symbol names, making it harder to reverse-engineer our app.

`shrinkResources` will remove any unused resources from our APK. This can be problematic if you are using reflection in your application to access resources indirectly, but that doesn't apply to our app.

Let's build an APK and see what's changed.

### 786 Kb (50% reduction)
We've reduced our APK size by half, with no noticeable effect on our application.

If you haven't already enabled `minifyEnabled` and `shrinkResources` in your application, this is the single most important thing you should take away from this post. You can easily save several megabytes of space, with only a a couple of hours of configuration and testing.

### AppCompat, we hardly knew ye
Our `classes.dex` now takes up 57% of the APK. The majority of these methods references belong to the  `android.support` package, so we're going to get rid of it. Let's perform the following changes:


- Remove the dependencies block from our `build.gradle` entirely

```
dependencies {
    implementation 'com.android.support:appcompat-v7:26.1.0'
    implementation 'com.android.support.constraint:constraint-layout:1.0.2'
    testImplementation 'junit:junit:4.12'
}
```

- Update the MainActivity to extend `android.app.Activity` rather than `AppCompatActivity`

```
public class MainActivity extends Activity
```

- Update our layout to use a single `TextView`.

```
<?xml version="1.0" encoding="utf-8"?>
<TextView xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center"
    android:text="Hello World!" />
```

- Delete `styles.xml` and remove the `android:theme` attribute from the ``<application>`` element in the `AndroidManifest`
- Delete `colors.xml`
- Sync gradle files

### 108 Kb bytes (87% reduction)
Holy cow, we just achieved nearly a 10x reduction from 786Kb, down to 108Kb. The only discernible change is the Toolbar colour, which now uses the default OS theme.

![No Support Library App Screenshot](/img/apkgolf/no-support-lib-app.png)

The res directory now takes up 95% of our APK size, due to all those launcher icons. If these icons were provided by our designer, then we could try [converting them to WebP](https://developer.android.com/studio/write/convert-webp.html), which is a more efficient file format supported on API 15 and above.

Fortunately, Google has already optimised our launch icons, although if this wasn't the case, you could also try running [ImageOptim](https://imageoptim.com/mac) to optimise and strip any unnecessary metadata from PNGs.

Let's be a bad citizen, and replace all our launch icons with a single 1-pixel black dot, placed in the unqualified `res/drawable` folder. Our new launch icon has been optimised with Gimp and ImageOptim down to 67 bytes, and is guaranteed to make both your designer and end-users cry.

### 6808 bytes (94% reduction)
Let's continue obliterating our resources, by optimising `resources.arsc`. This file currently references:

- 1 layout file
- 1 String used to display the app name
- 1 launcher icon drawable

Let's start at the top.

#### Layout file (6262 bytes, 9% reduction)
The Android framework will [inflate our XML file](https://developer.android.com/reference/android/view/LayoutInflater.html) into a `TextView`, then set the `contentView` of the `Activity`.

We could try removing the XML file, and doing this programmatically. This will be a tradeoff, as our `resources.arsc` and res directory will be reduced, but `classes.dex` will increase, as we will be referencing additional `TextView` methods from the Android framework.

```
TextView textView = new TextView(this);
textView.setText("Hello World!");
setContentView(textView);
```

Looks like we're down to 5710 bytes.

#### App Name (6034 bytes, 4% reduction)
Let's delete `strings.xml`, and replace `android:label` in the AndroidManifest with "A". This may seem like a small change, but will remove an entry from `resources.arsc`, a file from the res directory, and reduce the number of characters in the manifest. Every little helps.

#### Launcher icon (5300 bytes, 13% reduction)
As far as I know, there's no way to generate a PNG below 67 bytes. The [Android documentation](https://android.googlesource.com/platform/frameworks/native/+/jb-dev/libs/utils/README) also states that we need to include an integer id within `resources.arsc` that refers to our drawable resource.

These integer IDs have two namespaces:

>0x01: system resources (pre-installed in framework-res.apk)

>0x7f: application resources (bundled in the application .apk)

So what happens to our APK if we reference a resource in the 0x01 namespace? We should be able to get a nicer icon whilst simultaneously reducing our file size.

```
android:icon="@android:drawable/btn_star"
```

![System app icon Screenshot](/img/apkgolf/system-app-icon.jpg)

It goes without saying, but you should **never trust system resources** in a production application. This step will fail Google Play validation, and considering that certain manufacturers have been known to redefine the [colour white](https://www.reddit.com/r/androiddev/comments/71fpru/android_color_resources_not_safe/), the appearance of your app is effectively undefined.

#### Manifest (5252 bytes, 1% reduction)
`resources.arsc` is no longer generated as we don't bundle any resources with our APK, which leaves us with just `classes.dex`, and `AndroidManifest.xml`. We haven't touched the manifest yet, so there are some easy pickings here, namely removing:

```
android:allowBackup="true"
android:supportsRtl="true"
```

#### Proguard hack (4984 bytes, 5% reduction)
Let's refine our Proguard rule to remove `BuildConfig` and `R` from our Dex file.

```
-keep class com.fractalwrench.MainActivity { *; }
```

![classes.dex](/img/apkgolf/classes-dex.jpg)

#### Obfuscation (4936 bytes, 1% reduction)
Let's give our Activity an obfuscated name. Proguard does this automatically for regular classes, but as the manifest needs to know the Activity class name in order to launch it, this isn't obfuscated by default.

`MainActivity -> c.java`

`com.fractalwrench.apkgolf -> c.c`

### META-INF (3307 bytes, 33% reduction)
`META-INF` contains the v1 signature for the APK. Let's try generating with only the v2 signature instead, as this offers better protection as it signs the full APK, rather than just the JAR. It should also remove the `META-INF` files, because in v2 the signing is located at the end of the ZIP file, and isn't visible in the APK analyser tool.

To do this, we'll simply uncheck the v1 signature checkbox in the Android Studio UI, when generating a signed APK. Only signing with v1 produces an APK of 3511 bytes, whereas only signing with v2 produces an APK of 3307 bytes. In v2 the `CERT.RSA` and `CERT.SF` have disappeared. We have a winner!

APK signing V2:
https://source.android.com/security/apksigning/v2


## Where we're going, we won't need IDEs
It's time to edit our APK by hand. Creating an APK can be done in several steps, which are outlined below:

```
# 1. Creates an unsigned apk (zip file)
./gradlew assembleRelease

# 2. Run zipalign (technically optional)
$ANDROID_HOME/build-tools/26.0.1/zipalign -v -p 4 app-release-unsigned.apk app-release-aligned.apk

# 3. Run apksigner with v2 signature only, enter password
$ANDROID_HOME/build-tools/26.0.1/apksigner sign --v1-signing-enabled false --ks $HOME/fake.jks --out signed-release.apk app-release-unsigned.apk

# 4. Verify signature
$ANDROID_HOME/build-tools/26.0.1/apksigner verify signed-release.apk
```

Our unsigned and unaligned APK weighs in at 1902, which indicates that we're using at least 1Kb for the signing/aligning features.

<!-- TODO make an image/graphic? -->

TODO sources:

https://developer.android.com/studio/command-line/zipalign.html
https://developer.android.com/studio/command-line/apksigner.html
https://developer.android.com/studio/publish/app-signing.html#sign-manually


### Editing unzipped APK
After running `gradlew assembleRelease`, let's unzip the archive, then archive and sign the APK in the same way. This will prove we can manually edit the APK and run it on a real device.

```
unzip app-release-unsigned.apk -d app

# do any edits

zip -r app app.zip

# Sign as before
```

### File-size discrepancy (2764 bytes, 17% reduction)
Weird! Unzipping the unaligned APK and signing it manually appears to have knocked off 543 bytes by removing `META-INF/MANIFEST.MF`. I'm not entirely sure why this happens when done from the command line, so if anybody knows why, please get in touch!

### resources.arsc (2608 bytes, 6% reduction)
We are left with 3 files that are included into the signed APK. We can get rid of one, `resources.arsc`, because it's empty since we're not defining any resources.

That leaves us with the manifest and the `classes.dex` file, which each take up roughly half of the application size.

### ZEO (Zip engine optimisation) (2599 bytes, 0.5% reduction)
Let's change the application label to 'c', rather than 'A', and generate a signed APK. WTF? Why have we lost a byte here? both 'c' and 'A' are unicode characters which take up the same amount of space.

Oh wait, 'c' already appears in the manifest, within the activity name. The compression algorithm used to create an archive will reduce the file size further if some characters are more frequent than others. Let's exploit this with the following changes:

```
compileSdkVersion 26
    buildToolsVersion "26.0.1"
    defaultConfig {
        applicationId "c.c"
        minSdkVersion 26
        targetSdkVersion 26
        versionCode 26
        versionName "26"
    }
```

```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="c.c">

    <application
        android:icon="@android:drawable/btn_star"
        android:label="c"
        >
        <activity android:name="c.c.c">
```

We can revisit this later on - for now we've reclaimed 9 bytes.

### Abandoning user requirements (2462 bytes, 5% reduction)
To hit the truly minimal APK, let's git rid of those pesky user requirements. Originally we said we were going to have an app with a launcher icon that when clicked would display "Hello World" on screen. Anyone who's made it this far is probably going to know how to use ADB, so let's remove the launch icon requirement. Here's our new manifest:

```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="c.c">

    <application>
        <activity
            android:name="c"
            android:exported="true" />
    </application>
</manifest>
```

To launch the activity, we'll run:

```
adb shell am start -a android.intent.action.MAIN -n c.c/.c
```

### Where we're going, we don't need classes (2179 bytes, 12% reduction)
Let's take this to the logical conclusion, and get rid of our activity, replacing it with a custom `Application` class. This should still generate a valid, albeit useless APK. Our `classes.dex` file size will be reduced, as we are no longer referencing any `TextView`, `Bundle`, or `Activity` methods - only the `Application` constructor. Our manifest now looks like this:

```
package c.c;

import android.app.Application;

public class c extends Application {
}
```

```
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="c.c">
    <application android:name=".c" />
</manifest>
```
From now on, we can verify that our app has actually been installed by adb reporting success or failure. Or, we can have a look in the Settings app.

![Apk installation proof](/img/apkgolf/package-installation-proof.jpg)

### Dex Optimisation (1961 bytes, 10% reduction)
https://source.android.com/devices/tech/dalvik/dex-format
Overview of format:
https://source.android.com/devices/tech/dalvik/dex-format

I did a bunch of research into the Dex file format for this. But to cut a long story short, if your app doesn't launch an activity or perform a useful function, the only requirement for an APK to be installed is for the file to exist.

Therefore, we're going to open up the file in HexFiend, delete its contents, then save it as a zero-byte file, gaining us a 10% reduction.

### Sophisticated approach (1961 bytes, 0% reduction)
Our manifest from the unsigned APK is in a binary format which doesn't appear to be documented. There appear to be a few interesting things that are revealed by its structure. The first 4 bytes signify a version number (38), and the next 2 bytes show the size of the file (660).

Let's try deleting a byte by setting the targetSdkVersion to 1, and updating the file size header to 659. Unfortunately this doesn't pass verification, so it looks like there's some extra complexity here which we'll have to revisit.

The next step is to substitute every item with dummy characters without changing the file size, to see if there's some sort of checksum in place. This will show which attributes cannot be removed. Surprisingly, it looks like we can substitute quite a few of the keys with no ill-effect.

Values that can't be changed:

```
manifest
package
```

### Stupid approach (1777 bytes, 9% reduction)
After several hours researching how a binary XML manifest is encoded, I took the high-tech approach of systematically replacing bytes with 0, and seeing whether the APK installed.

Fun fact, the following passes validation on a Nexus 5X. Warning: if you do this in production, it will cause the Google Engineer responsible for maintaining the Android framework class `BinaryXMLParser.java` to scream very loudly into a pillow.

![Non-essential manifest parts](/img/apkgolf/non-essential-manifest-parts.jpg)

This doesn't change the bytes in the file, but if you remember our zip compression hack from earlier, this will reduce the overall size of the APK. It will also make it a lot easier to see what the important parts of the manifest are.

This also leaves us with a nice view of how the manifest file is structured using HexFiend, as we can hide the null bytes.

UTF-8:
![Minified AndroidManifest](/img/apkgolf/minified-android-manifest.png)

Hexadecimal:
![Minified AndroidManifest](/img/apkgolf/minified-android-manifest-hex.png)

### Done? (1757 bytes, 1% reduction)
Let's inspect the final APK.

![Name in signed APK](/img/apkgolf/name-in-signed-apk.png)

Huh, it seems like after all this time, I left my name in the APK. That will be at least a few bytes we can recover if we create another keystore. Let's exploit the zip compression hack too, by calling everything c.

![Keystore ccccccc](/img/apkgolf/cccccc.png)

### Stage 5: acceptance
I'm fairly happy with 1757 bytes as the smallest APK, even though I'm sure someone on the internet will have another low-level trick to beat me. If you do have a further optimisation, please get in touch!

In summary, there is such a thing as too much optimisation, and I should really have given up a couple of afternoons earlier and studied some Kotlin instead. But there you have it ladies and gentlemen. The world's smallest APK...so far.



### Further work
There are various other things we could probably do to shave off a few more bytes, such as:

- Brute-force generation of keystores to improve compression
- Taking a less naive approach to AndroidManifest.xml and reducing bytes there
- Further Zip Compression hacks (count characters using wc, optimise on the most common char)

But this was only meant to take an afternoon to complete, so I'll leave that as an exercise for the listener.



- Crazy hacks the reader can think of? Get in touch.



# TODO





Writeup notes:
- 12.5 tweets!
- Host repo with smallest APK ever
- Took about 5 minutes to get 99% of the gains, and several Sunday afternoons to realise the rest. You have to decide whether it's worth the engineering effort.
- MEASURE EVERYTHING. You WILL be surprised by what takes up the most space, or takes the longest time to execute in your application.
- WTFs or things that don't make sense are often a clue
